name: Python Face Registration & Recognition Test CI

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  test:
    runs-on: self-hosted-linux
    
    # Run the entire job inside a container
    container:
      image: python:3.12
      options: >-
        --privileged
        --volume /var/run/docker.sock:/var/run/docker.sock
        --volume /usr/bin/docker:/usr/bin/docker

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Docker Compose binary
        uses: actions/cache@v4
        with:
          path: ~/.docker/cli-plugins/docker-compose
          key: docker-compose-v2.39.3

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y wget unzip sudo curl
          DOCKER_CONFIG=${DOCKER_CONFIG:-$HOME/.docker}
          mkdir -p $DOCKER_CONFIG/cli-plugins
          if [ ! -f "$DOCKER_CONFIG/cli-plugins/docker-compose" ]; then
            echo "Downloading Docker Compose..."
            curl -SL https://github.com/docker/compose/releases/download/v2.39.3/docker-compose-linux-x86_64 \
              -o $DOCKER_CONFIG/cli-plugins/docker-compose
            chmod +x $DOCKER_CONFIG/cli-plugins/docker-compose
          else
            echo "Using cached Docker Compose binary"
          fi

      - name: Download models
        id: download-models
        run: |
          pip install gdown
          gdown 1PTZrQwo_tv34J8fAZ6em1DEr1ymFLPvg
          unzip -o models.zip -d face_reg_recog_milvus/app/triton_server
          rm models.zip

      - name: Create .env file
        working-directory: face_reg_recog_milvus
        run: |
            copy .env.example .env

      - name: Add hosts to /etc/hosts
        run: |
            echo "127.0.0.1  standalone" >> /etc/hosts
            echo "127.0.0.1  mysql" >> /etc/hosts
            echo "127.0.0.1  redis-server" >> /etc/hosts
            echo "127.0.0.1  uvicorn_trt_server" >> /etc/hosts

      - name: Build Docker Compose services
        working-directory: face_reg_recog_milvus
        run: |
            docker compose build
            docker image prune -f

      - name: Start Docker Compose & trt server services
        working-directory: face_reg_recog_milvus
        shell: bash
        run: |
          sudo rm -rf volumes
          mkdir -p volumes/person_images
          docker compose down
          docker compose up -d uvicorn_trt_server etcd minio standalone attu mysql mysql-admin redis-server

          # Wait for services to be ready
          sleep 10

      - name: Run PyTest
        working-directory: face_reg_recog_milvus
        run: |
          pip install -r requirements.txt &&
          pip install -r tests/requirements.txt &&
          pytest tests -v --tb=short

      - name: Stop Docker Compose services
        working-directory: face_reg_recog_milvus
        run: docker compose down